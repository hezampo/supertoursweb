<?php/** * Description of TripsController * *  */Doo::loadController('I18nController');class RoutesController extends I18nController {    public function beforeRun($resource, $action) {        if (!isset($_SESSION['login'])) {            return Doo::conf()->APP_URL;        }    }    public function index() {        // Cargamos el paginador        Doo::loadHelper('DooPager');        if (!isset($this->params['type_rate'])) {            $type_rate = "0";        } else {            $type_rate = $this->params['type_rate'];        }        if (!isset($_POST["id_agencya"])) {            if (!isset($this->params['id_agency'])) {                $id_agency = "-1";            } else {                $id_agency = $this->params['id_agency'];            }        } else {            $id_agency = $_POST["id_agencya"];        }        if (!isset($_POST["acompany"])) {            if (!isset($this->params['acompany'])) {                $acompany = "";            } else {                $acompany = $this->params['acompany'];            }        } else {            $acompany = $_POST["acompany"];        }        if (!isset($_POST["filtro"])) {            if (!isset($this->params['filtro'])) {                $filtro = "trip_no";            } else {                $filtro = $this->params['filtro'];            }        } else {            $filtro = $_POST["filtro"];        }        if (!isset($_POST["texto"])) {            if (!isset($this->params['texto'])) {                $texto = "";            } else {                $texto = $this->params['texto'];            }        } else {            $texto = $_POST["texto"];        }//        if ($type_rate == 2) {////            $from = "from routes_net t1 ////                      left join areas t2 ON (t1.trip_from = t2.id)////                      LEFT JOIN areas t3 ON (t1.trip_to = t3.id)////                      left join agencia t4 ON (t1.id_agency = t4.id)";//        } else {////            $from = "from routes t1 ////                      left join areas t2 ON (t1.trip_from = t2.id)////                      LEFT JOIN areas t3 ON (t1.trip_to = t3.id)";//        }//        if ($type_rate == 2 && $id_agency == "-1") {////            $where = "t1.type_rate=" . $type_rate . " and " . $filtro . " like ?  ";////            $param = array($texto . '%');////            $rs = Doo::db()->query("select COUNT(*) " . $from . " where " . $where, $param);//        } else {////            $where = "t1.type_rate=" . $type_rate . " and id_agency = ? and " . $filtro . " like ?  ";////            $param = array($id_agency, $texto . '%');////            $rs = Doo::db()->query("select COUNT(*) " . $from . " where " . $where, $param);//        }////////////        $total = $rs->fetchColumn();////////        if ($total == 0)//            $total = 1;////        // iniciamos el paginador////////        $pager = new DooPager(Doo::conf()->APP_URL . "admin/routes/$filtro/$texto/$type_rate/$id_agency/$acompany/page", $total, 6, 5);////////        if (isset($this->params['pindex']))//            $pager->paginate(intval($this->params['pindex']));//        else//            $pager->paginate(1);//        $sql = "select distinct t1.id, t1.trip_no, t2.nombre AS trip_from, t3.nombre AS trip_to, t1.stprc_adult, t1.stprc_child, t1.sflexprc_child, t1.sflexprc_adult, t1.trip_departure,////                       " . (($type_rate == 2) ? "t4.company_name," : "") . "////                       t1.trip_arrival,t1.fecha_ini, t1.fecha_fin, t1.type_rate " . $from . " where  " . $where . "  Order By fecha_ini  and trip_no desc limit " . $pager->limit;        $sql = "SELECT DISTINCT trip_no FROM routes WHERE trip_from='1' AND trip_to = '3' OR trip_from='3' AND trip_to='2' ORDER BY trip_no" . $pager->limit;//        $rs = Doo::db()->query($sql, $param);        $rs = Doo::db()->query($sql);        $trips = $rs->fetchAll();        $this->data['rootUrl'] = Doo::conf()->APP_URL;        $this->data['content'] = 'configuracion/matrix.php';        $this->data['type_rate'] = $type_rate;        $this->data['texto'] = $texto;        $this->data['id_agency'] = $id_agency;        $this->data['acompany'] = $acompany;        $this->data['filtro'] = $filtro;        $this->data['trips'] = $trips;        $this->data['pager'] = $pager->output;        $this->renderc('admin/index', $this->data, true);    }    public function add() {        Doo::loadModel("Routes");        $trip = new Routes();        $this->data['rootUrl'] = Doo::conf()->APP_URL;        $this->data['trip'] = $trip;        $this->data['areas'] = Doo::db()->find("Areas", array("asArray" => true));        $this->data['tripsnumber'] = Doo::db()->find("Trips", array("asArray" => true));//        $this->data['content'] = 'configuracion/frm_route.php';        $this->data['content'] = 'configuracion/frm_rates1.php';        $this->data['dato'] = "New";        $this->renderc('admin/index', $this->data);    }    public function add_Net_especial() {        Doo::loadModel("Routes_Net");        $trip = new Routes_Net();        $this->data['rootUrl'] = Doo::conf()->APP_URL;        $this->data['trip'] = $trip;        $this->data['areas'] = Doo::db()->find("Areas", array("asArray" => true));        $this->data['tripsnumber'] = Doo::db()->find("Trips", array("asArray" => true));        $this->data['content'] = "configuracion/frm_rates2.php";        Doo::loadModel("Routes");        $routes = new Routes_Net();        $this->data["routes"] = $routes;        $this->renderc('admin/index', $this->data);    }//    function devuelveArrayFechasEntreOtrasDos($fechaInicio, $fechaFin){//        $arrayFechas=array();//        $fechaMostrar = $fechaInicio;////        while(strtotime($fechaMostrar) <= strtotime($fechaFin)) {//        $arrayFechas[]=$fechaMostrar;//        $fechaMostrar = date("d-m-Y", strtotime($fechaMostrar . " + 1 day"));//        }////        return $arrayFechas;//        }     public function save() {        Doo::loadModel("Routes");        Doo::loadModel("Routes_Net");        if ($_POST['type_rate'] == 2) {            $trip = new Routes_Net($_POST);        } else {            $trip = new Routes($_POST);        }        $new = false;        $this->data['rootUrl'] = Doo::conf()->APP_URL;//        $fecha_ini = $_POST['fecha_ini'];//        //echo $fecha_ini;////        $fecha_ini2 = $_POST['fecha_ini2'];//        //echo $fecha_ini2;////        $stprc_adult = $_POST['stprc_adult'];//////        $stprc_child = $_POST['stprc_child'];//        echo '>>' . $stprc_child . '<br />';////        $stprc_adult2 = $_POST['stprc_adult2'];//        echo '>>' . $stprc_adult2 . '<br />';////        $stprc_child2 = $_POST['stprc_child2'];//        echo '>>' . $stprc_child2 . '<br />';////        $trip_viaje = $_POST['trip_viaje'];//        echo 'el trip>>' . $trip_viaje . '<br />';                $trip_nro = $_POST['trip_nro'];                if($trip_nro == '100' || $trip_nro == '200' ){               $fecha_ini = $_POST['fecha_ini'];//        $fecha_ini2 = $_POST['fecha_ini2'];        $vehicles = $_POST['vehicles'];        $capacity = $_POST['capacity'];        $seats_remain = $_POST['seats_remain'];        $spprc_adult = $_POST['spprc_adult'];        $spprc_child = $_POST['spprc_child'];        $sdprc_adult = $_POST['sdprc_adult'];        $sdprc_child = $_POST['sdprc_child'];        $wfprc_adult = $_POST['wfprc_adult'];        $wfprc_child = $_POST['wfprc_child'];        $stprc_adult = $_POST['stprc_adult'];        $stprc_child = $_POST['stprc_child'];        $sflexprc_adult = $_POST['sflexprc_adult'];        $sflexprc_child = $_POST['sflexprc_child'];        $flresprc_adult = $_POST['flresprc_adult'];        $flresprc_child = $_POST['flresprc_child'];        $spseats = $_POST['spseats'];        $sdseats = $_POST['sdseats'];        $wfseats = $_POST['wfseats'];        $stseats = $_POST['stseats'];        $sflexseats = $_POST['sflexseats'];        $spprcseats = $_POST['spprcseats'];        $toursseats = $_POST['toursseats'];        $univext = $_POST['univext'];        $wdext = $_POST['wdext'];        //de Orlando a sus respectivas areas        $f1t3 = $_POST['f1t3'];        $f1t4 = $_POST['f1t4'];        $f1t5 = $_POST['f1t5'];        $f1t6 = $_POST['f1t6'];        $f1t7 = $_POST['f1t7'];        $f1t8 = $_POST['f1t8'];        $f1t9 = $_POST['f1t9'];        $f1t10 = $_POST['f1t10'];        $f1t19 = $_POST['f1t19'];        $f1t11 = $_POST['f1t11'];        $f1t12 = $_POST['f1t12'];        $f1t13 = $_POST['f1t13'];        $f1t14 = $_POST['f1t14'];        //de Kissimmee a sus respectivas areas        $f2t3 = $_POST['f2t3'];        $f2t4 = $_POST['f2t4'];        $f2t5 = $_POST['f2t5'];        $f2t6 = $_POST['f2t6'];        $f2t7 = $_POST['f2t7'];        $f2t8 = $_POST['f2t8'];        $f2t9 = $_POST['f2t9'];        $f2t10 = $_POST['f2t10'];        $f2t19 = $_POST['f2t19'];        $f2t11 = $_POST['f2t11'];        $f2t12 = $_POST['f2t12'];        $f2t13 = $_POST['f2t13'];        $f2t14 = $_POST['f2t14'];        //de Fort Pierce a sus respectivas areas        $f3t4 = $_POST['f3t4'];        $f3t5 = $_POST['f3t5'];        $f3t6 = $_POST['f3t6'];        $f3t7 = $_POST['f3t7'];        $f3t8 = $_POST['f3t8'];        $f3t9 = $_POST['f3t9'];        $f3t10 = $_POSTt['f3t10'];             $f3t19 = $_POST['f3t19'];        $f3t11 = $_POST['f3t11'];        $f3t12 = $_POST['f3t12'];        $f3t13 = $_POST['f3t13'];        $f3t14 = $_POST['f3t14'];        //de Lake$_POSTorth a sus respectivas areas        $f4t5 = $_POST['f4t5'];        $f4t6 = $_POST['f4t6'];        $f4t7 = $_POST['f4t7'];        $f4t8 = $_POST['f4t8'];        $f4t9 = $_POST['f4t9'];        $f4t10 = $_POST['f4t10'];        $f4t19 = $_POST['f4t19'];        $f4t11 = $_POST['f4t11'];        $f4t12 = $_POST['f4t12'];        $f4t13 = $_POST['f4t13'];        $f4t14 = $_POST['f4t14'];        //de  Fort Lauderdale a sus respectivas areas        $f5t6 = $_POST['f5t6'];        $f5t7 = $_POST['f5t7'];        $f5t8 = $_POST['f5t8'];        $f5t9 = $_POST['f5t9'];        $f5t10 = $_POST['f5t10'];        $f5t19 = $_POST['f5t19'];        $f5t11 = $_POST['f5t11'];        $f5t12 = $_POST['f5t12'];        $f5t13 = $_POST['f5t13'];        $f5t14 = $_POST['f5t14'];               $datos = array(            $trip_nro = $_POST['trip_nro'],            $fecha_ini = $fecha_ini,            $vehicles = $_POST['vehicles'],            $capacity = $_POST['capacity'],            $seats_remain = $_POST['seats_remain'],            $spprc_adult = $_POST['spprc_adult'],            $spprc_child = $_POST['spprc_child'],            $sdprc_adult = $_POST['sdprc_adult'],            $sdprc_child = $_POST['sdprc_child'],            $wfprc_adult = $_POST['wfprc_adult'],            $wfprc_child = $_POST['wfprc_child'],            $stprc_adult = $_POST['stprc_adult'],            $stprc_child = $_POST['stprc_child'],            $sflexprc_adult = $_POST['sflexprc_adult'],            $sflexprc_child = $_POST['sflexprc_child'],            $flresprc_adult = $_POST['flresprc_adult'],            $flresprc_child = $_POST['flresprc_child'],            $spseats = $_POST['spseats'],            $sdseats = $_POST['sdseats'],            $wfseats = $_POST['wfseats'],            $stseats = $_POST['stseats'],            $sflexseats = $_POST['sflexseats'],            $spprcseats = $_POST['spprcseats'],            $toursseats = $_POST['toursseats'],            $univext = $_POST['univext'],            $wdext = $_POST['wdext'],            //de Orlando a sus respectivas areas            $f1t3 = $_POST['f1t3'],            $f1t4 = $_POST['f1t4'],            $f1t5 = $_POST['f1t5'],            $f1t6 = $_POST['f1t6'],//            $f1t7 = $_POST['f1t7'],            $f1t8 = $_POST['f1t8'],            $f1t9 = $_POST['f1t9'],            $f1t10 = $_POST['f1t10'],            $f1t19 = $_POST['f1t19'],            $f1t11 = $_POST['f1t11'],            $f1t12 = $_POST['f1t12'],//            $f1t13 = $_POST['f1t13'],//            $f1t14 = $_POST['f1t14'],            //de Kissimmee a sus respectivas areas            $f2t3 = $_POST['f2t3'],            $f2t4 = $_POST['f2t4'],            $f2t5 = $_POST['f2t5'],            $f2t6 = $_POST['f2t6'],//            $f2t7 = $_POST['f2t7'],            $f2t8 = $_POST['f2t8'],            $f2t9 = $_POST['f2t9'],            $f2t10 = $_POST['f2t10'],            $f2t19 = $_POST['f2t19'],            $f2t11 = $_POST['f2t11'],            $f2t12 = $_POST['f2t12'],//            $f2t13 = $_POST['f2t13'],//            $f2t14 = $_POST['f2t14'],            //de Fort Pierce a sus respectivas areas            $f3t4 = $_POST['f3t4'],            $f3t5 = $_POST['f3t5'],            $f3t6 = $_POST['f3t6'],//            $f3t7 = $_POST['f3t7'],            $f3t8 = $_POST['f3t8'],            $f3t9 = $_POST['f3t9'],            $f3t10 = $_POST['f3t10'],            $f3t19 = $_POST['f3t19'],            $f3t11 = $_POST['f3t11'],            $f3t12 = $_POST['f3t12'],//            $f3t13 = $_POST['f3t13'],//            $f3t14 = $_POST['f3t14'],            //de Lake$_POSTorth a sus respectivas areas            $f4t5 = $_POST['f4t5'],            $f4t6 = $_POST['f4t6'],//            $f4t7 = $_POST['f4t7'],            $f4t8 = $_POST['f4t8'],            $f4t9 = $_POST['f4t9'],            $f4t10 = $_POST['f4t10'],            $f4t19 = $_POST['f4t19'],            $f4t11 = $_POST['f4t11'],            $f4t12 = $_POST['f4t12'],//            $f4t13 = $_POST['f4t13'],//            $f4t14 = $_POST['f4t14'],            //FordLauderdale            $f5t6 = $_POST['f5t6'],//            $f5t7 = $_POST['f5t7'],            $f5t8 = $_POST['f5t8'],            $f5t9 = $_POST['f5t9'],            $f5t10 = $_POST['f5t10'],            $f5t19 = $_POST['f5t19'],            $f5t11 = $_POST['f5t11'],            $f5t12 = $_POST['f5t12'],//            $f5t13 = $_POST['f5t13'],//            $f5t14 = $_POST['f5t14']        );        }else{            echo "hola mundo";        }//        echo '<pre>';//        print_r($datos);//        exit();//        echo '</pre>';        list($mes, $dia, $anio) = explode('-', $fecha_ini);        $fecha = $anio . '-' . $mes . '-' . $dia;        $fecha_iniforma = (strtotime("$fecha -1 hour"));        echo '>>' . $fecha_iniforma . '<br />';        list($mes, $dia, $anio) = explode('-', $fecha_ini2);        $fecha2 = $anio . '-' . $mes . '-' . $dia;        $fecha_iniforma2 = (strtotime("$fecha2 -1 hour"));        echo '>>' . $fecha_iniforma2 . '<br />';//        print($fecha_ini);//        exit();//        $fecha_iniforma = '1475294400';//        $fecha_iniforma2 = '1475380800';//        $trip_no = '100';//        //        $stprc_adult = '800';//        $stprc_child = '800';//        $stprc_adult2 = '800';//        $stprc_child2 = '800';        if ($new) {            Doo::db()->insert($trip);        } else {            //Doo::db()->update($trip);            $sql = "SELECT * FROM  routes WHERE fecha_ini between '$fecha_iniforma' AND '$fecha_iniforma2' AND trip_no = '$trip_nro'  AND type_rate = 0 AND trip_from = 1 AND trip_to = 3 ";            $rs = Doo::db()->query($sql);            $trips = $rs->fetchAll();            $num = count($trips);//                echo '<pre>';//                print_r($num);//                echo '</pre>';//                exit();                 if ($num == 0) {                Doo::db()->insert($routes);            } else {                                 if($trip_nro == '100' || $trip_nro == '200' ){                //actualiza solo el primer registro                Doo::db()->query("UPDATE routes SET vehicles='$vehicles', capacity='$capacity', seats_remain='$seats_remain', spprc_adult='$spprc_adult', spprc_child ='$spprc_child', sdprc_adult='$sdprc_adult', sdprc_child = '$sdprc_child', wfprc_adult = '$wfprc_adult', wfprc_child = '$wfprc_child', stprc_adult = '$stprc_adult', stprc_child = '$stprc_child', f1t3='$f1t3' WHERE fecha_ini ='$fecha_iniforma' AND trip_no = '$trip_no' AND type_rate = '0' AND trip_from = '1' AND trip_to = '3'");                Doo::db()->query("UPDATE routes SET vehicles='$vehicles', capacity='$capacity', seats_remain='$seats_remain', spprc_adult='$spprc_adult', spprc_child ='$spprc_child', sdprc_adult='$sdprc_adult', sdprc_child = '$sdprc_child', wfprc_adult = '$wfprc_adult', wfprc_child = '$wfprc_child', stprc_adult = '$stprc_adult', stprc_child = '$stprc_child', f1t4='$f1t4' WHERE fecha_ini ='$fecha_iniforma' AND trip_no = '$trip_no' AND type_rate = '0' AND trip_from = '1' AND trip_to = '4'");                                  //actualuza solo el segundo registro//                Doo::db()->query("UPDATE routes SET stprc_adult = '$stprc_adult2', stprc_child = '$stprc_child2' WHERE fecha_ini ='$fecha_iniforma2' AND trip_no = '$trip_no' AND type_rate = '0' AND trip_from = '1' AND trip_to = '3'");                }                $type_rate = $_POST['type_rate'];                //echo '>>'.$type_rate;                return Doo::conf()->APP_URL . "admin/routes/" . $type_rate;                             }        }    }    public function edit() {        $item = $_POST['item'];        //echo 'trip>>'.$item;        $mes1 = $_REQUEST['mes1'];        //echo ' mes>>'.$mes1;        $anio = $_REQUEST['anio1'];        //echo ' anio>>'.$anio;        Doo::loadModel("Routes");        Doo::loadModel("Agency");        Doo::loadModel("Routes_Net");        $k = explode(":", $this->params["pindex"]);        if ($k[1] == "2") {            $trip = new Routes_Net();            $agency = new Agency();        } else {            $trip = new Routes();        }        $this->data['item'] = $item; //trip        $this->data['mes'] = $mes1;        $this->data['anio'] = $anio;        $trip->id = $k[0];        $this->data['rootUrl'] = Doo::conf()->APP_URL;        $this->data['trip'] = Doo::db()->find($trip, array('limit' => 1));        $this->data['areas'] = Doo::db()->find("Areas", array("asArray" => true));        $this->data['tripsnumber'] = Doo::db()->find("Trips", array("asArray" => true));        $agency = new Agency();        $agency->id = $this->data['trip']->id_agency;        $this->data['agency'] = Doo::db()->find($agency, array('limit' => 1));        if ($this->data['trip']->type_rate == 2) {            $this->data['content'] = 'configuracion/frm_route_especial.php';        } else {            $this->data['content'] = 'configuracion/frm_route.php';        }        $this->data['dato'] = "edit";        $this->view()->renderc('admin/index', $this->data);    }    public function delete() {        Doo::loadModel("Routes");        Doo::loadModel("Routes_Net");        $k = explode(":", $_REQUEST['item']);        if ($k[1] == "2") {            $trip = new Routes_Net();        } else {            $trip = new Routes();        }        $trip->id = $k[0];        Doo::db()->delete($trip);        return Doo::conf()->APP_URL . "admin/routes/" . $k[1];    }    public function trip_from() {        $trip = $this->params['trip'];        $sql = "SELECT DISTINCT a.id, a.nombre		 			FROM   `areas`  a LEFT JOIN `routes` r ON (a.id = r.trip_from)		 			WHERE  trip_no = ? Order By a.`nombre` ASC ";        $rs = Doo::db()->query($sql, array($trip));        $area = $rs->fetchAll();        echo "<option value='0'>Select Option</option>";        echo "<option value='*'>\"ALL POINTS OF DEPARTURE\"</option>";        foreach ($area as $e) {            echo "<option value='" . $e["id"] . "'>" . $e["nombre"] . "</option>";        }    }    public function trip_to() {        $trip = $this->params['trip'];        $from = $this->params['from'];        echo $sql = "SELECT DISTINCT a.id, a.nombre		 			FROM   `areas`  a LEFT JOIN `routes` r ON (a.id = r.trip_to)		 			WHERE  r.trip_no = ?  AND r.trip_from = ? Order By a.`nombre` ASC ";        $rs = Doo::db()->query($sql, array($trip, $from));        $area = $rs->fetchAll();        echo "<option value='0'>Select Option</option>";        if (count($area) > 0) {            echo "<option value='*'>\"ALL POINTS OF ARRIVAL\"</option>";        }        foreach ($area as $e) {            echo "<option value='" . $e["id"] . "'>" . $e["nombre"] . " </option>";        }    }}